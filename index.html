<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>TalkSpace</title>
    <style>
        body { font-family: Arial; margin: 0; padding: 20px; background: #f0f0f0; }
        .container { display: flex; gap: 20px; }
        .auth { background: white; padding: 20px; border-radius: 10px; }
        .app { display: none; background: white; padding: 20px; border-radius: 10px; width: 600px; }
        input { padding: 10px; margin: 5px; display: block; width: 200px; }
        button { padding: 10px; margin: 5px; cursor: pointer; }
        .tabs { display: flex; margin-bottom: 10px; }
        .tab { padding: 10px; cursor: pointer; border: 1px solid #ccc; }
        .tab.active { background: #667eea; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .messages { height: 300px; border: 1px solid #ccc; padding: 10px; overflow-y: auto; margin-bottom: 10px; }
        .message { margin: 5px 0; padding: 8px; border-radius: 5px; }
        .message.own { background: #667eea; color: white; margin-left: 50px; }
        .message.other { background: #f0f0f0; margin-right: 50px; }
        .user-list { height: 200px; border: 1px solid #ccc; padding: 10px; overflow-y: auto; margin-bottom: 10px; }
        .user-item { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; }
        .user-item:hover { background: #f9f9f9; }
    </style>
</head>
<body>
    <div class="container">
        <div class="auth" id="authScreen">
            <h1>üí¨ TalkSpace</h1>
            <input type="text" id="usernameInput" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <input type="password" id="passwordInput" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            <button onclick="login()">–í—Ö–æ–¥</button>
            <div id="status" style="margin-top: 10px; color: red;"></div>
        </div>

        <div class="app" id="appScreen">
            <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="userName"></span> <span id="userAvatar"></span></h2>
            
            <div class="tabs">
                <div class="tab active" onclick="openTab('friends')">–î—Ä—É–∑—å—è</div>
                <div class="tab" onclick="openTab('search')">–ü–æ–∏—Å–∫</div>
                <div class="tab" onclick="openTab('global')">–û–±—â–∏–π —á–∞—Ç</div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ –î—Ä—É–∑—å—è -->
            <div id="friendsTab" class="tab-content active">
                <div class="user-list" id="friendsList">–î—Ä—É–∑–µ–π –Ω–µ—Ç</div>
                <div id="privateChat" style="display: none;">
                    <h3>–ß–∞—Ç —Å <span id="chatWith"></span></h3>
                    <div class="messages" id="privateMessages"></div>
                    <input type="text" id="privateMessageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="width: 100%;">
                    <button onclick="sendPrivateMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ –ü–æ–∏—Å–∫ -->
            <div id="searchTab" class="tab-content">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." style="width: 100%;" oninput="searchUsers()">
                <div class="user-list" id="searchResults">–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–ª—è –ø–æ–∏—Å–∫–∞</div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ –û–±—â–∏–π —á–∞—Ç -->
            <div id="globalTab" class="tab-content">
                <div class="messages" id="globalMessages"></div>
                <input type="text" id="globalMessageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–±—â–∏–π —á–∞—Ç..." style="width: 100%;">
                <button onclick="sendGlobalMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = io();
        let currentUser = null;
        let currentChat = null;
        
        socket.on('connect', () => {
            showStatus('‚úÖ Connected to server', 'green');
        });
function register() {
            const username = document.getElementById('usernameInput').value;
            const password = document.getElementById('passwordInput').value;
            if (username && password) {
                socket.emit('register', { username, password });
            }
        }

        function login() {
            const username = document.getElementById('usernameInput').value;
            const password = document.getElementById('passwordInput').value;
            if (username && password) {
                socket.emit('login', { username, password });
            }
        }

        function openTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function searchUsers() {
            const query = document.getElementById('searchInput').value;
            if (query.length > 1) socket.emit('search_users', query);
        }

        function sendFriendRequest(username) {
            socket.emit('send_friend_request', username);
            event.target.textContent = '–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω';
            event.target.disabled = true;
        }

        function openPrivateChat(friend) {
            currentChat = friend.username;
            document.getElementById('privateChat').style.display = 'block';
            document.getElementById('chatWith').textContent = friend.username + ' ' + friend.avatar;
            document.getElementById('privateMessages').innerHTML = '';
            socket.emit('load_chat_history', friend.username);
        }

        function sendPrivateMessage() {
            const input = document.getElementById('privateMessageInput');
            const text = input.value.trim();
            if (text && currentChat) {
                socket.emit('private_message', { to: currentChat, text });
                input.value = '';
            }
        }

        function sendGlobalMessage() {
            const input = document.getElementById('globalMessageInput');
            const text = input.value.trim();
            if (text) {
                socket.emit('global_message', text);
                input.value = '';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        socket.on('register_success', (data) => {
            currentUser = data.user;
            showApp();
        });

        socket.on('login_success', (data) => {
            currentUser = data.user;
            showApp();
            updateFriendsList(data.friends);
        });

        socket.on('register_error', showError);
        socket.on('login_error', showError);

        socket.on('search_results', (results) => {
            const html = results.map(user => 
                <div class="user-item">
                    ${user.avatar} ${user.username}
                    <button onclick="sendFriendRequest('${user.username}')" style="float: right;">
                        –î–æ–±–∞–≤–∏—Ç—å
                    </button>
                </div>
            ).join('');
            document.getElementById('searchResults').innerHTML = html || '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
        });

        socket.on('friend_added', (friend) => {
            const friendsList = document.getElementById('friendsList');
            if (friendsList.innerHTML === '–î—Ä—É–∑–µ–π –Ω–µ—Ç') friendsList.innerHTML = '';
            friendsList.innerHTML += 
                <div class="user-item" onclick="openPrivateChat(${JSON.stringify(friend)})">
                    ${friend.avatar} ${friend.username}
                </div>
            ;
        });

        socket.on('new_private_message', (message) => {
            addPrivateMessage(message);
        });

        socket.on('new_global_message', (message) => {
            addGlobalMessage(message);
        });
socket.on('chat_history', (data) => {
            data.messages.forEach(addPrivateMessage);
        });

        function showApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.username;
            document.getElementById('userAvatar').textContent = currentUser.avatar;
        }

        function showStatus(message, color) {
            const status = document.getElementById('status');
            status.innerHTML = message;
            status.style.color = color;
        }

        function showError(error) {
            showStatus('‚ùå ' + error, 'red');
        }

        function updateFriendsList(friends) {
            const html = friends.map(friend => 
                <div class="user-item" onclick="openPrivateChat(${JSON.stringify(friend)})">
                    ${friend.avatar} ${friend.username}
                </div>
            ).join('');
            document.getElementById('friendsList').innerHTML = html || '–î—Ä—É–∑–µ–π –Ω–µ—Ç';
        }

        function addPrivateMessage(message) {
            const isOwn = message.from === currentUser.username;
            const html = 
                <div class="message ${isOwn ? 'own' : 'other'}">
                    <strong>${isOwn ? '–í—ã' : message.from}</strong> ${message.fromAvatar}<br>
                    ${message.text}<br>
                    <small>${message.time}</small>
                </div>
            ;
            document.getElementById('privateMessages').innerHTML += html;
            document.getElementById('privateMessages').scrollTop = document.getElementById('privateMessages').scrollHeight;
        }

        function addGlobalMessage(message) {
            const isOwn = message.from === currentUser.username;
            const html = 
                <div class="message ${isOwn ? 'own' : 'other'}">
                    <strong>${isOwn ? '–í—ã' : message.from}</strong> ${message.fromAvatar}<br>
                    ${message.text}<br>
                    <small>${message.time}</small>
                </div>
            ;
            document.getElementById('globalMessages').innerHTML += html;
            document.getElementById('globalMessages').scrollTop = document.getElementById('globalMessages').scrollHeight;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (document.getElementById('globalTab').classList.contains('active')) {
                    sendGlobalMessage();
                } else if (document.getElementById('privateMessageInput').value) {
                    sendPrivateMessage();
                }
            }
        });
    </script>
</body>
</html>
